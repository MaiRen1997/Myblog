---
title: request的使用
date: 2026-01-23 14:04:37
permalink: /pages/cf73dd/
categories:
  - 后端
  - Python学习
  - 第三方库的使用
tags:
  - 
author: 
  name: Riverside Joy
  link: https://github.com/MaiRen1997
---
## 基本请求方法

### GET 请求

```python
import requests

# 基础 GET
response = requests.get('https://httpbin.org/get')
print(response.status_code)  # 200
print(response.text)         # 响应内容

# 带参数的 GET
params = {'key1': 'value1', 'key2': 'value2'}
response = requests.get('https://httpbin.org/get', params=params)
print(response.url)  # https://httpbin.org/get?key1=value1&key2=value2

# 从响应中解析 JSON
data = response.json()
print(data['args'])  # {'key1': 'value1', 'key2': 'value2'}
```

### POST 请求

```python
# 表单数据
data = {'username': 'admin', 'password': 'secret'}
response = requests.post('https://httpbin.org/post', data=data)
print(response.json()['form'])  # {'username': 'admin', 'password': 'secret'}

# JSON 数据
json_data = {'name': 'John', 'age': 30}
response = requests.post('https://httpbin.org/post', json=json_data)
print(response.json()['json'])  # {'name': 'John', 'age': 30}

# 文件上传
files = {'file': open('test.txt', 'rb')}
response = requests.post('https://httpbin.org/post', files=files)
```

### PUT, DELETE, PATCH, HEAD, OPTIONS

```python
# PUT 请求
response = requests.put('https://httpbin.org/put', data={'key': 'value'})

# DELETE 请求
response = requests.delete('https://httpbin.org/delete')

# PATCH 请求
response = requests.patch('https://httpbin.org/patch', data={'update': 'data'})

# HEAD 请求（只获取头部）
response = requests.head('https://httpbin.org/get')
print(response.headers)

# OPTIONS 请求
response = requests.options('https://httpbin.org/get')
print(response.headers.get('Allow'))  # GET,HEAD,OPTIONS
```

## 请求参数配置

### Headers 设置

```python
headers = {
    'User-Agent': 'MyApp/1.0',
    'Authorization': 'Bearer token123',
    'Content-Type': 'application/json'
}
response = requests.get('https://httpbin.org/headers', headers=headers)
print(response.json()['headers'])
```

### Cookies 设置和获取

```python
# 发送 Cookies
cookies = {'session_id': 'abc123'}
response = requests.get('https://httpbin.org/cookies', cookies=cookies)
print(response.json())  # {"cookies": {"session_id": "abc123"}}

# 接收 Cookies
response = requests.get('https://httpbin.org/cookies/set?name=value')
print(response.cookies)      # <RequestsCookieJar>
print(response.cookies.get('name'))  # value
```

### 超时设置

```python
# 请求超时（秒）
try:
    response = requests.get('https://httpbin.org/delay/5', timeout=3)
except requests.exceptions.Timeout:
    print("请求超时！")

# 连接超时和读取超时分别设置
response = requests.get('https://httpbin.org/get', timeout=(3.05, 27))
```

### 代理设置

```python
proxies = {
    'http': 'http://10.10.1.10:3128',
    'https': 'http://10.10.1.10:1080',
}
response = requests.get('http://example.com', proxies=proxies)

# SOCKS 代理（需要安装 requests[socks]）
proxies = {
    'http': 'socks5://user:pass@host:port',
    'https': 'socks5://user:pass@host:port'
}
```

### SSL验证

```python
# 禁用 SSL 验证（不安全，仅测试用）
response = requests.get('https://httpbin.org/get', verify=False)

# 使用自定义证书
response = requests.get('https://httpbin.org/get', verify='/path/to/cert.pem')

# 客户端证书
response = requests.get('https://httpbin.org/get', 
                       cert=('/path/client.cert', '/path/client.key'))
```

## 响应处理

### 响应属性

```python
response = requests.get('https://httpbin.org/get')

# 状态码
print(f"状态码: {response.status_code}")
print(f"状态描述: {response.reason}")

# 响应头
print(f"响应头: {response.headers}")
print(f"Content-Type: {response.headers['Content-Type']}")
print(f"编码: {response.encoding}")

# 响应内容
print(f"文本内容: {response.text}")
print(f"二进制内容: {response.content}")
print(f"JSON内容: {response.json()}")

# 原始响应
raw_response = response.raw
```

### 响应状态检查

```python
response = requests.get('https://httpbin.org/status/404')
print(f"成功: {response.ok}")           # False
print(f"状态码: {response.status_code}") # 404

# 抛出 HTTP 错误（非 200）
response.raise_for_status()  # 如果状态码不是 2xx，会抛出异常
```

### 流式响应

```python
# 下载大文件
response = requests.get('https://httpbin.org/stream/100', stream=True)
for line in response.iter_lines():
    if line:
        print(line.decode('utf-8'))

# 分块下载
with requests.get('https://example.com/large-file.zip', stream=True) as r:
    r.raise_for_status()
    with open('large-file.zip', 'wb') as f:
        for chunk in r.iter_content(chunk_size=8192):
            f.write(chunk)
```

## 会话管理

### session会话

```python
# 使用 Session 保持会话（cookies、headers等）
session = requests.Session()

# 设置会话级参数
session.headers.update({'User-Agent': 'MyApp/1.0'})
session.cookies.update({'session_token': 'xyz789'})

# 使用会话发起请求
response1 = session.get('https://httpbin.org/cookies')
print(response1.json())

# 会话中的请求会保持状态
response2 = session.get('https://httpbin.org/headers')
print(response2.json())
```

### 适配器配置

```python
from requests.adapters import HTTPAdapter
from urllib3.util.retry import Retry

# 创建会话
session = requests.Session()

# 配置重试策略
retry_strategy = Retry(
    total=3,                      # 总重试次数
    backoff_factor=1,             # 退避因子
    status_forcelist=[429, 500, 502, 503, 504],  # 重试状态码
    allowed_methods=["GET", "POST"]  # 重试的HTTP方法
)

# 创建适配器
adapter = HTTPAdapter(max_retries=retry_strategy)

# 挂载适配器
session.mount("http://", adapter)
session.mount("https://", adapter)

# 使用
response = session.get("http://example.com")
```

## 高级功能

### 钩子函数

```python
# 定义钩子函数
def print_url(r, *args, **kwargs):
    print(f"URL: {r.url}")

def check_status(r, *args, **kwargs):
    r.raise_for_status()

# 使用钩子
hooks = {'response': [print_url, check_status]}
response = requests.get('https://httpbin.org/get', hooks=hooks)
```

### 事件钩子

```python
def response_callback(r, *args, **kwargs):
    print(f"响应时间: {r.elapsed.total_seconds()}秒")
    return r

# 注册事件
requests.get('https://httpbin.org/get', hooks={'response': response_callback})
```

### 自定义身份验证

```python
from requests.auth import HTTPBasicAuth, HTTPDigestAuth

# Basic 认证
response = requests.get('https://httpbin.org/basic-auth/user/passwd',
                       auth=HTTPBasicAuth('user', 'passwd'))

# Digest 认证
response = requests.get('https://httpbin.org/digest-auth/auth/user/passwd',
                       auth=HTTPDigestAuth('user', 'passwd'))

# 自定义认证类
class TokenAuth(requests.auth.AuthBase):
    def __init__(self, token):
        self.token = token
    
    def __call__(self, r):
        r.headers['Authorization'] = f'Token {self.token}'
        return r

response = requests.get('https://httpbin.org/headers', 
                       auth=TokenAuth('my-secret-token'))
```

## 错误处理

```python
import requests
from requests.exceptions import RequestException

urls = [
    'https://httpbin.org/get',
    'https://httpbin.org/status/404',
    'https://invalid-url.com'
]

for url in urls:
    try:
        response = requests.get(url, timeout=5)
        response.raise_for_status()
        print(f"{url}: 成功")
    except requests.exceptions.HTTPError as e:
        print(f"{url}: HTTP错误 - {e}")
    except requests.exceptions.ConnectionError as e:
        print(f"{url}: 连接错误 - {e}")
    except requests.exceptions.Timeout as e:
        print(f"{url}: 超时错误 - {e}")
    except requests.exceptions.RequestException as e:
        print(f"{url}: 请求错误 - {e}")
```

## 实用工具

### 请求重定向

```python
# 禁用重定向
response = requests.get('https://httpbin.org/redirect/2', allow_redirects=False)
print(response.status_code)  # 302
print(response.headers['Location'])

# 启用重定向（默认）
response = requests.get('https://httpbin.org/redirect/2', allow_redirects=True)
print(response.status_code)  # 200
print(response.history)  # 重定向历史列表
```

### 编码处理

```python
# 自动检测编码
response = requests.get('https://example.com')
response.encoding = response.apparent_encoding  # 自动检测
print(response.text)

# 手动指定编码
response.encoding = 'utf-8'
```

### 连接池

```python
# 保持连接
with requests.Session() as session:
    adapter = requests.adapters.HTTPAdapter(pool_connections=10, 
                                           pool_maxsize=100)
    session.mount('http://', adapter)
    session.mount('https://', adapter)
    
    # 多个请求会重用连接
    responses = []
    for i in range(5):
        responses.append(session.get('https://httpbin.org/get'))
```

## 常见用例

### 下载文件

```python
import requests

url = 'https://example.com/image.jpg'
response = requests.get(url, stream=True)

with open('image.jpg', 'wb') as f:
    for chunk in response.iter_content(chunk_size=1024):
        f.write(chunk)
```

### API分页获取

```python
def get_all_pages(base_url, params=None):
    """获取所有分页数据"""
    all_data = []
    page = 1
    
    while True:
        params = params or {}
        params['page'] = page
        
        response = requests.get(base_url, params=params)
        data = response.json()
        
        if not data.get('results'):
            break
        
        all_data.extend(data['results'])
        
        if not data.get('next'):
            break
            
        page += 1
    
    return all_data
```













































