---
title: datetime模块的使用
date: 2026-01-26 14:08:14
permalink: /pages/0fd069/
categories:
  - 后端
  - Python学习
  - 第三方库的使用
tags:
  - 
author: 
  name: Riverside Joy
  link: https://github.com/MaiRen1997
---
## 基础导入和使用

### 获取当前时间

```python
from datetime import datetime, date, time, timedelta, timezone
now = datetime.now()
print(now)  # 2023-01-26 15:30:45.123456
```

### 获取当前日期

```python
today = date.today()
print(today)  # 2023-01-26
```

### 创建特定时间

```python
dt = datetime(2023, 12, 25, 10, 30, 45)
print(dt)  # 2023-12-25 10:30:45
```

### 创建特定日期

```python
d = date(2023, 12, 25)
print(d)  # 2023-12-25
```

### 创建时间对象

```python
t = time(15, 30, 45)
print(t)  # 15:30:45
```

## 时间运算(核心功能)

### 时间加法

```python
from datetime import datetime, timedelta

now = datetime.now()

# 1. 时间加法
tomorrow = now + timedelta(days=1)
next_week = now + timedelta(weeks=1)
future = now + timedelta(days=10, hours=5, minutes=30)
```

### 时间减法

```python
yesterday = now - timedelta(days=1)
past = now - timedelta(hours=3, minutes=15)
```

### 计算时间差

```python
dt1 = datetime(2023, 1, 1)
dt2 = datetime(2023, 12, 31)
time_diff = dt2 - dt1
print(time_diff)        # 364 days, 0:00:00
print(time_diff.days)   # 364
print(time_diff.seconds) # 0
```

### timedelta参数(7个)

```python
# 4. timedelta参数
delta = timedelta(
    days=5,
    seconds=3600,      # 1小时
    microseconds=500000,
    milliseconds=1000,  # 1秒
    minutes=30,
    hours=2,
    weeks=1
)
print(delta)  # 12 days, 3:30:01.500000
```

## 格式化与解析

### datetime转字符串

```python
from datetime import datetime

# 1. datetime → 字符串（格式化）
dt = datetime.now()

# 常用格式
print(dt.strftime("%Y-%m-%d %H:%M:%S"))      # 2023-01-26 15:30:45
print(dt.strftime("%Y年%m月%d日"))           # 2023年01月26日
print(dt.strftime("%A, %B %d, %Y"))          # Thursday, January 26, 2023
print(dt.strftime("%I:%M %p"))               # 03:30 PM
print(dt.strftime("%Y%m%d_%H%M%S"))          # 20230126_153045
```

### 字符串转datetime

```python
# 2. 字符串 → datetime（解析）
date_str = "2023-01-26 15:30:45"
dt = datetime.strptime(date_str, "%Y-%m-%d %H:%M:%S")


# 更多解析示例
dt1 = datetime.strptime("26/01/2023", "%d/%m/%Y")
dt2 = datetime.strptime("Jan 26, 2023 3:30 PM", "%b %d, %Y %I:%M %p")
```

### ISO格式(推荐)

```python
# 3. ISO格式（推荐）
dt = datetime.now()
iso_string = dt.isoformat()        # 2023-01-26T15:30:45.123456
iso_date_string = dt.date().isoformat()  # 2023-01-26
```

### ISO格式解析

```python
# 从ISO格式解析
dt_from_iso = datetime.fromisoformat("2023-01-26T15:30:45")
```

## 时间戳操作

### datetime与时间戳互转

```python
import time
from datetime import datetime

# 1. datetime ↔ 时间戳
dt = datetime.now()

# 获取时间戳（浮点数，秒）
timestamp = dt.timestamp()        # 1674725445.123456
timestamp_int = int(dt.timestamp())  # 1674725445

# 从时间戳创建datetime
dt_from_ts = datetime.fromtimestamp(1674725445)
dt_from_ts_float = datetime.fromtimestamp(1674725445.123456)
```

### 与time模块交互

```python
# 2. 与time模块交互
# 获取当前时间戳
ts1 = time.time()        # time模块
ts2 = datetime.now().timestamp()  # datetime模块
```

### 毫秒时间戳

```python
# 3. 毫秒时间戳
timestamp_ms = int(dt.timestamp() * 1000)  # 毫秒级时间戳
dt_from_ms = datetime.fromtimestamp(timestamp_ms / 1000)
```

## 时区处理

### 基本时区操作

```python
from datetime import datetime, timezone, timedelta
import pytz  # 需要安装：pip install pytz

# 1. 基本时区操作
# 创建UTC时间
utc_now = datetime.now(timezone.utc)
print(utc_now)  # 2023-01-26 07:30:45.123456+00:00
```

### 创建自定义时区

```python
# 2. 创建自定义时区
# 东八区（北京时间）
beijing_tz = timezone(timedelta(hours=8))
beijing_time = datetime.now(beijing_tz)
```

### 时区转换

```python
# 3. 时区转换
utc_time = datetime.now(timezone.utc)
beijing_time = utc_time.astimezone(timezone(timedelta(hours=8)))
```

### 实用pytz(更强大)

#### 获取时区

```python
import pytz

# 获取时区
tz_shanghai = pytz.timezone('Asia/Shanghai')
tz_ny = pytz.timezone('America/New_York')
```

#### 本地化时间

```python
# 本地化时间
local_dt = tz_shanghai.localize(datetime.now())
```

#### 转换现有时间

```python
# 或转换现有时间
utc_dt = datetime.now(timezone.utc)
shanghai_dt = utc_dt.astimezone(tz_shanghai)
```

#### 获取所有时区

```python
# 5. 所有时区
for tz in pytz.all_timezones[:10]:  # 查看前10个时区
    print(tz)
```

#### 夏令时处理

```python
# 6. 夏令时处理
tz_london = pytz.timezone('Europe/London')
```

#### pytz自动处理夏令时

```python
# pytz会自动处理夏令时
dt_summer = tz_london.localize(datetime(2023, 6, 1, 12, 0))  # 夏令时
dt_winter = tz_london.localize(datetime(2023, 12, 1, 12, 0))  # 标准时
```

## 日期时间组件访问

### 访问各个组件

```python
from datetime import datetime

dt = datetime.now()

# 1. 访问各个组件
print(dt.year)        # 2023
print(dt.month)       # 1
print(dt.day)         # 26
print(dt.hour)        # 15
print(dt.minute)      # 30
print(dt.second)      # 45
print(dt.microsecond) # 123456
print(dt.weekday())   # 0-6 (周一为0)
print(dt.isoweekday()) # 1-7 (周一为1)
print(dt.isocalendar()) # (2023, 4, 3) - (年, 周数, 星期几)
```

### 替换部分时间

```python
# 2. 替换部分时间
new_dt = dt.replace(year=2024, month=12, hour=9)
print(new_dt)  # 2024-12-26 09:30:45.123456
```

### 仅日期或时间

```python
# 3. 仅日期或时间
print(dt.date())  # 2023-01-26 (date对象)
print(dt.time())  # 15:30:45.123456 (time对象)
```

### 组合日期和时间

```python
# 4. 组合日期和时间
from datetime import date, time
d = date(2023, 1, 26)
t = time(15, 30, 45)
dt_combined = datetime.combine(d, t)
```

## 实用工具函数

### 检查日期有效性

```python
from datetime import datetime, timedelta

# 1. 检查日期有效性
def is_valid_date(year, month, day):
    try:
        datetime(year, month, day)
        return True
    except ValueError:
        return False
```

### 计算年龄

```python
# 2. 计算年龄
def calculate_age(birth_date):
    today = date.today()
    age = today.year - birth_date.year
    # 如果今年还没过生日，年龄减1
    if (today.month, today.day) < (birth_date.month, birth_date.day):
        age -= 1
    return age

```

### 获取本月最后一天

```python
# 3. 获取本月最后一天
def last_day_of_month(year, month):
    # 下个月的第一天减去1天
    if month == 12:
        next_month = datetime(year+1, 1, 1)
    else:
        next_month = datetime(year, month+1, 1)
    return (next_month - timedelta(days=1)).day
```

### 工作日计算

```python
# 4. 工作日计算
def add_business_days(start_date, business_days):
    current_date = start_date
    days_added = 0
    
    while days_added < business_days:
        current_date += timedelta(days=1)
        # 周一至周五为工作日
        if current_date.weekday() < 5:  # 0-4 是周一到周五
            days_added += 1
    
    return current_date
```

### 时间范围生成器

```python
# 5. 时间范围生成器
def date_range(start_date, end_date):
    current_date = start_date
    while current_date <= end_date:
        yield current_date
        current_date += timedelta(days=1)

# 使用示例
start = datetime(2023, 1, 1)
end = datetime(2023, 1, 10)
for single_date in date_range(start, end):
    print(single_date.strftime("%Y-%m-%d"))
```

## 最佳实践示例

```python
from datetime import datetime, timedelta
import json
from typing import Dict, Any

class DateTimeHelper:
    """日期时间工具类"""
    
    # 常用格式常量
    FORMAT_DATETIME = "%Y-%m-%d %H:%M:%S"
    FORMAT_DATE = "%Y-%m-%d"
    FORMAT_TIME = "%H:%M:%S"
    FORMAT_COMPACT = "%Y%m%d_%H%M%S"
    
    @staticmethod
    def get_current_datetime() -> datetime:
        """获取当前时间"""
        return datetime.now()
    
    @staticmethod
    def format_datetime(dt: datetime, fmt: str = None) -> str:
        """格式化时间"""
        if fmt is None:
            fmt = DateTimeHelper.FORMAT_DATETIME
        return dt.strftime(fmt)
    
    @staticmethod
    def parse_datetime(date_str: str, fmt: str = None) -> datetime:
        """解析字符串为datetime"""
        if fmt is None:
            # 尝试自动识别格式
            for fmt in [DateTimeHelper.FORMAT_DATETIME, 
                       DateTimeHelper.FORMAT_DATE,
                       "%Y/%m/%d %H:%M:%S",
                       "%Y-%m-%dT%H:%M:%S"]:
                try:
                    return datetime.strptime(date_str, fmt)
                except ValueError:
                    continue
            raise ValueError(f"无法解析时间字符串: {date_str}")
        return datetime.strptime(date_str, fmt)
    
    @staticmethod
    def datetime_to_dict(dt: datetime) -> Dict[str, Any]:
        """datetime转换为字典"""
        return {
            "year": dt.year,
            "month": dt.month,
            "day": dt.day,
            "hour": dt.hour,
            "minute": dt.minute,
            "second": dt.second,
            "timestamp": dt.timestamp(),
            "isoformat": dt.isoformat(),
            "weekday": dt.weekday(),
            "isoweekday": dt.isoweekday()
        }
    
    @staticmethod
    def datetime_to_json(dt: datetime) -> str:
        """datetime转换为JSON"""
        return json.dumps({
            "datetime": dt.isoformat(),
            "timestamp": dt.timestamp()
        })
    
    @staticmethod
    def calculate_time_diff(start: datetime, end: datetime) -> Dict[str, float]:
        """计算时间差"""
        diff = end - start
        return {
            "total_seconds": diff.total_seconds(),
            "days": diff.days,
            "hours": diff.total_seconds() / 3600,
            "minutes": diff.total_seconds() / 60
        }

# 使用示例
helper = DateTimeHelper()

# 1. 获取和格式化当前时间
now = helper.get_current_datetime()
formatted = helper.format_datetime(now)
print(f"当前时间: {formatted}")

# 2. 时间计算
start_time = datetime(2023, 1, 1, 9, 0, 0)
end_time = datetime(2023, 1, 1, 17, 30, 45)
time_diff = helper.calculate_time_diff(start_time, end_time)
print(f"时间差: {time_diff}")

# 3. 序列化
dt_dict = helper.datetime_to_dict(now)
dt_json = helper.datetime_to_json(now)
```

## 常见问题技巧

```python
# 1. 性能优化：避免重复创建对象
def process_dates(dates_list):
    """处理日期列表"""
    result = []
    for date_str in dates_list:
        # ❌ 避免：每次循环都调用datetime.now()
        # current_time = datetime.now()
        
        # ✅ 正确：在循环外获取一次
        pass
    
    current_time = datetime.now()  # 在循环外获取
    for date_str in dates_list:
        dt = datetime.strptime(date_str, "%Y-%m-%d")
        if dt > current_time:
            result.append(dt)
    return result

# 2. 处理时区的最佳实践
def handle_timezone_safely():
    """安全处理时区"""
    # 始终使用aware datetime（带时区）
    utc_now = datetime.now(timezone.utc)
    
    # 转换时区
    target_tz = timezone(timedelta(hours=8))
    local_time = utc_now.astimezone(target_tz)
    
    # 存储时使用UTC
    timestamp = utc_now.timestamp()  # 存储这个
    return local_time, timestamp

# 3. 日期比较的陷阱
def date_comparison_tips():
    """日期比较注意事项"""
    # 比较日期部分
    dt1 = datetime(2023, 1, 26, 10, 0, 0)
    dt2 = datetime(2023, 1, 26, 15, 0, 0)
    
    # 比较完整时间
    print(dt1 < dt2)  # True
    
    # 只比较日期部分
    print(dt1.date() == dt2.date())  # True
    
    # 处理时区不同的比较
    utc_time = datetime.now(timezone.utc)
    local_time = datetime.now()  # naive datetime
    
    # 先转换为相同时区再比较
    local_utc = local_time.replace(tzinfo=timezone.utc)
    print(utc_time == local_utc)  # 可能为False

# 4. 处理数据库中的时间
def database_time_handling():
    """数据库时间处理"""
    # 存入数据库前转换为UTC
    import pytz
    
    user_timezone = pytz.timezone('Asia/Shanghai')
    user_dt = user_timezone.localize(datetime.now())
    utc_dt = user_dt.astimezone(pytz.utc)
    
    # 存储utc_dt.timestamp() 或 utc_dt.isoformat()
    
    # 从数据库读取后转换为用户时区
    db_timestamp = 1674725445.123
    db_utc_dt = datetime.fromtimestamp(db_timestamp, tz=pytz.utc)
    user_dt = db_utc_dt.astimezone(user_timezone)
    
    return user_dt
```



