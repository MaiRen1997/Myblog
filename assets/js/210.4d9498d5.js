(window.webpackJsonp=window.webpackJsonp||[]).push([[210],{666:function(t,a,s){"use strict";s.r(a);var n=s(7),e=Object(n.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"十五分钟读懂react-17"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#十五分钟读懂react-17"}},[t._v("#")]),t._v(" 十五分钟读懂React 17")]),t._v(" "),a("p",[t._v("作为时下最火的前端框架之一，React每次发版都会带来创新的改变，如React最早提出虚拟DOM、React 16引入fiber架构，再到后来React 16.8提出令人耳目一新的Hooks，这些创新也是很多人推崇React的一个重要原因。然而，到了React 17，rc发布日志上竟然说这次版本最大的特点就是"),a("strong",[t._v("无新特性")]),t._v("，从目前来说，这个日志是让很多人失望了。")]),t._v(" "),a("p",[t._v("这么多人对这次发版失望，那React 17就真的没什么好说的吗？显然不是，至少我认为不是的，从长远来看，无论是项目角度，还是源码学习角度，作为一个资深reactress，我还是有很多东西要学习的。")]),t._v(" "),a("p",[t._v("首先面对用户的更改，React官网上说的很详细了。如果你是一个React开发者，并且不想永远停留在老版本，想深入了解React 17，想知道新版本对你开发的影响，那接下来我们来聊聊应该从哪些角度。")]),t._v(" "),a("h2",{attrs:{id:"一、全新的-jsx-转换"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、全新的-jsx-转换"}},[t._v("#")]),t._v(" 一、全新的 JSX 转换")]),t._v(" "),a("p",[a("code",[t._v("React 17以前")]),t._v("，React中如果使用JSX，则必须像下面这样导入React，否则会报错，这是因为"),a("strong",[t._v("旧的 JSX 转换")]),t._v("会把 JSX 转换为 "),a("code",[t._v("React.createElement(...)")]),t._v(" 调用。")]),t._v(" "),a("div",{staticClass:"language-jsx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-jsx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" React "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'react'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" ReactDOM "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'react-dom'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" app "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token plain-text"}},[t._v("hello react")]),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 注意这里的定义方式(以纯html定义，无法使用函数定义)")]),t._v("\nReactDOM"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("render")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getElementById")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'root'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br")])]),a("p",[t._v("如果把第一行代码去掉，就会报错")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6a98398065494902956f3a1ef600a6ee~tplv-k3u1fbpfcp-watermark.awebp",alt:"image-20201110172720403"}})]),t._v(" "),a("p",[t._v("当然，这并不完美，除了增加了学习成本，还有无法做到的"),a("a",{attrs:{href:"https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Freactjs%2Frfcs%2Fblob%2Fcreatelement-rfc%2Ftext%2F0000-create-element-changes.md%23motivation",target:"_blank",rel:"noopener noreferrer"}},[t._v("性能优化和简化"),a("OutboundLink")],1),t._v("， 如createElement里还要动态做children的拼接、依赖于React的导入等等。")]),t._v(" "),a("p",[t._v("而"),a("code",[t._v("React 17")]),t._v("带来了改变，"),a("code",[t._v("可以让我们单独使用 JSX 而无需引入 React")]),t._v("。这是因为新的 JSX 转换"),a("strong",[t._v("不会将 JSX 转换为 React.createElement")]),t._v("，而是自动从 React 的 package 中引入新的入口函数并调用。另外此次升级不会改变 JSX 语法，旧的 JSX 转换也将继续工作。")]),t._v(" "),a("div",{staticClass:"language-jsx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-jsx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" ReactDOM "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'react-dom'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" app "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token plain-text"}},[t._v("hello react")]),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 注意这里的定义方式(以纯html定义，无法使用函数定义)")]),t._v("\nReactDOM"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("render")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getElementById")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'root'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br")])]),a("p",[t._v("如上代码也不会报错了")]),t._v(" "),a("h2",{attrs:{id:"二、事件委托的变更"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、事件委托的变更"}},[t._v("#")]),t._v(" 二、事件委托的变更")]),t._v(" "),a("p",[t._v("在 React 16 或更早版本中，React 会由于事件委托对大多数事件执行 "),a("code",[t._v("document.addEventListener()")]),t._v("。但是一旦你想要局部使用React，那么React中的事件会影响全局，如下面这个例子，当把React和jQuery一起使用，那么当点击input的时候，document上和React不相关的事件也会被触发，这符合React的预期，但是并不符合用户的预期。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1c339f24dedb4be5855739e85175ee95~tplv-k3u1fbpfcp-watermark.awebp",alt:"image-20201110151901137"}})]),t._v(" "),a("p",[t._v("令人开心的是，这次的React 17就解决了这个问题~，这次React 不再将事件添加在"),a("code",[t._v("document")]),t._v(" 上，而是添加到渲染 React 树的根 DOM 容器中：")]),t._v(" "),a("div",{staticClass:"language-jsx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-jsx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" rootNode "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getElementById")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'root'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nReactDOM"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("render")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("App")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" rootNode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n复制代码\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])]),a("p",[t._v("这种改变不仅方便了局部使用React的项目，还可以用于项目的逐步升级，如一部分使用React 18，另一部分使用React 19，事件是分开的，这样也就不会相互影响。当然这并不是鼓励大家在一个项目中使用多个React版本，而只是作为一种临时处理的过渡~")]),t._v(" "),a("p",[t._v("好了，如果你只是励志做个普通工程师，可以跳到下个小章节看了，如果是Reactress，继续往下看：")]),t._v(" "),a("p",[t._v("下图形象描述了这次的变更，图片来自React官网"),a("a",{attrs:{href:"https://link.juejin.cn/?target=https%3A%2F%2Freact.docschina.org%2Fblog%2F2020%2F10%2F20%2Freact-v17.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("react.docschina.org/blog/2020/1…"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1578b41a1a184b808b1607a174b1b6f1~tplv-k3u1fbpfcp-watermark.awebp",alt:"此图展示了 React 17 如何将事件连接到根节点而非 document"}})]),t._v(" "),a("p",[t._v("自从其发布以来，React 一直自动进行事件委托。当触发 DOM 事件时，React 会找出调用的组件，然后 React 事件会在组件中向上 “冒泡”。这被称为"),a("a",{attrs:{href:"https://link.juejin.cn/?target=https%3A%2F%2Fdavidwalsh.name%2Fevent-delegate",target:"_blank",rel:"noopener noreferrer"}},[t._v("事件委托"),a("OutboundLink")],1),t._v("。除了在大型应用程序上具有性能优势外，它还使添加类似于 "),a("a",{attrs:{href:"https://link.juejin.cn/?target=https%3A%2F%2Ftwitter.com%2Fdan_abramov%2Fstatus%2F1200118229697486849",target:"_blank",rel:"noopener noreferrer"}},[t._v("replaying events"),a("OutboundLink")],1),t._v(" 这样的新特性变得更加容易。")]),t._v(" "),a("p",[t._v("事件委托，也就是我们通常提到的事件代理机制，这种机制不会把时间处理函数直接绑定在真实的节点上，而是把所有的事件绑定到结构的最外层，使用一个统一的事件监听和处理函数。当组件挂载或卸载时，只是在这个统一的事件监听器上插入或删除一些对象；当事件发生时，首先被这个统一的事件监听器处理，然后在映射表里找到真正的事件处理函数并调用。这样做简化了事件处理和回收机制，效率也有很大提升。")]),t._v(" "),a("h2",{attrs:{id:"三、事件系统相关更改"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、事件系统相关更改"}},[t._v("#")]),t._v(" 三、事件系统相关更改")]),t._v(" "),a("p",[t._v("除了事件委托这种比较大的更改，事件系统上还发生了一些小的更改，")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("与以往不同，React 17中"),a("code",[t._v("onScroll")]),t._v(" 事件不再冒泡，以防止"),a("a",{attrs:{href:"https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Freact%2Fissues%2F15723",target:"_blank",rel:"noopener noreferrer"}},[t._v("出现常见的混淆"),a("OutboundLink")],1),t._v("。")])]),t._v(" "),a("li",[a("p",[t._v("React 的 "),a("code",[t._v("onFocus")]),t._v(" 和 "),a("code",[t._v("onBlur")]),t._v(" 事件已在底层切换为原生的 "),a("code",[t._v("focusin")]),t._v(" 和 "),a("code",[t._v("focusout")]),t._v(" 事件。它们更接近 React 现有行为，有时还会提供额外的信息。")])]),t._v(" "),a("li",[a("p",[t._v("捕获事件（例如，"),a("code",[t._v("onClickCapture")]),t._v("）现在使用的是实际浏览器中的捕获监听器。")])])]),t._v(" "),a("p",[t._v("这些更改会使 React 与浏览器行为更接近，并提高了互操作性。")]),t._v(" "),a("blockquote",[a("p",[t._v("注意：")]),t._v(" "),a("p",[t._v("尽管 React 17 "),a("strong",[t._v("底层")]),t._v("已将 "),a("code",[t._v("onFocus")]),t._v(" 事件从 "),a("code",[t._v("focus")]),t._v(" 切换为 "),a("code",[t._v("focusin")]),t._v("，但请注意，这并未影响冒泡行为。在 React 中，"),a("code",[t._v("onFocus")]),t._v(" 事件总是冒泡的，在 React 17 中会继续保持，因为通常它是一个更有用的默认值。请参阅 "),a("a",{attrs:{href:"https://link.juejin.cn/?target=https%3A%2F%2Fcodesandbox.io%2Fs%2Fstrange-albattani-7tqr7%3Ffile%3D%2Fsrc%2FApp.js",target:"_blank",rel:"noopener noreferrer"}},[t._v("sandbox"),a("OutboundLink")],1),t._v("，以了解为不同特定用例添加不同检查。")])]),t._v(" "),a("h2",{attrs:{id:"四、去除事件池"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四、去除事件池"}},[t._v("#")]),t._v(" 四、去除事件池")]),t._v(" "),a("p",[t._v("在React 17 以前，如果想要用异步的方式使用事件e，则必须先调用调用 "),a("code",[t._v("e.persist()")]),t._v(" 才可以，这是因为 React 在旧浏览器中重用了不同事件的事件对象，以提高性能，并将所有事件字段在它们之前设置为 "),a("code",[t._v("null")]),t._v("。如下面的例子：")]),t._v(" "),a("div",{staticClass:"language-jsx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-jsx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("FunctionComponent")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("props")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("val"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" setVal"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("useState")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("handleChange")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("e")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// setVal(e.target.value);")]),t._v("\n    \n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// React 17以前，如果想用异步的方式使用事件e，必须要加上下面的e.persist()才可以")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// e.persist();")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// setVal(data => e.target.value);")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("className")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("border"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token plain-text"}},[t._v("\n      ")]),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("input")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("type")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("text"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("value")]),a("span",{pre:!0,attrs:{class:"token script language-javascript"}},[a("span",{pre:!0,attrs:{class:"token script-punctuation punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("val"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("onChange")]),a("span",{pre:!0,attrs:{class:"token script language-javascript"}},[a("span",{pre:!0,attrs:{class:"token script-punctuation punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("handleChange"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),a("span",{pre:!0,attrs:{class:"token plain-text"}},[t._v("\n    ")]),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n复制代码\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br")])]),a("p",[t._v("但是这种使用方式有点抽象，经常会让对React不太熟悉的开发者懵掉，但是值得开心的是，React 17 中移除了 “event pooling（事件池）“，因为以前加入事件池的概念是为了提升旧浏览器的性能，对于现代浏览器来说，已经不需要了。因此，上面的代码中不使用e.persist();也能达到预期效果。")]),t._v(" "),a("h2",{attrs:{id:"五、副作用清理时间"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#五、副作用清理时间"}},[t._v("#")]),t._v(" 五、副作用清理时间")]),t._v(" "),a("p",[t._v("React 17以前，当组件被卸载时，useEffect和useLayoutEffect的清理函数都是同步运行，但是对于大型应用程序来说，这不是理想选择，因为同步会减缓屏幕的过渡（例如，切换标签），因此"),a("strong",[t._v("React 17中的useEffect的清理函数异步执行")]),t._v("，也就是说如果要卸载组件，则清理会在屏幕更新后运行。如果你某些情况下你仍然希望依靠同步执行，可以用 "),a("code",[t._v("useLayoutEffect")]),t._v("。")]),t._v(" "),a("p",[t._v("当然React 17中的useEffect的清理函数异步执行之后，有一个隐患：")]),t._v(" "),a("div",{staticClass:"language-jsx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-jsx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("useEffect")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  someRef"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("current"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("someSetupMethod")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    someRef"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("current"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("someCleanupMethod")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n复制代码\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br")])]),a("p",[t._v("问题在于 "),a("code",[t._v("someRef.current")]),t._v(" 是可变的，因此在运行清除函数时，它可能已经设置为 "),a("code",[t._v("null")]),t._v("。解决方案是在副作用"),a("strong",[t._v("内部")]),t._v("存储会发生变化的值：")]),t._v(" "),a("div",{staticClass:"language-jsx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-jsx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("useEffect")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" instance "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" someRef"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("current"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  instance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("someSetupMethod")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    instance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("someCleanupMethod")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n复制代码\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br")])]),a("p",[t._v("我们不希望此问题对大家造成影响，我们提供了 "),a("a",{attrs:{href:"https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Freact%2Ftree%2Fmaster%2Fpackages%2Feslint-plugin-react-hooks",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("eslint-plugin-react-hooks/exhaustive-deps")]),t._v(" 的 lint 规则"),a("OutboundLink")],1),t._v("（请确保在项目中使用它）会对此情况发出警告。")]),t._v(" "),a("h2",{attrs:{id:"六、返回一致的-undefined-错误"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#六、返回一致的-undefined-错误"}},[t._v("#")]),t._v(" 六、返回一致的 undefined 错误")]),t._v(" "),a("p",[t._v("在 React 16 及更早版本中，返回 "),a("code",[t._v("undefined")]),t._v(" 始终是一个错误，当然这是React的预期，但是由于编码错误 ，"),a("code",[t._v("forwardRef")]),t._v(" 和 "),a("code",[t._v("memo")]),t._v(" 组件的返回值是undefined的时候没有做为错误，React 17中修复了这个问题。React中要求对于不想进行任何渲染的时候返回 "),a("code",[t._v("null")]),t._v("。")]),t._v(" "),a("h2",{attrs:{id:"七、原生组件栈"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#七、原生组件栈"}},[t._v("#")]),t._v(" 七、原生组件栈")]),t._v(" "),a("p",[a("strong",[t._v("在 React 17 中，使用了不同的机制生成组件调用栈，该机制会将它们与常规的原生 JavaScript 调用栈缝合在一起。这使得你可以在生产环境中获得完全符号化的 React 组件调用栈信息。")])]),t._v(" "),a("h2",{attrs:{id:"八、移除私有导出"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#八、移除私有导出"}},[t._v("#")]),t._v(" 八、移除私有导出")]),t._v(" "),a("p",[t._v("React 17删除了一些以前暴露给其他项目的 React 内部组件。特别是，"),a("a",{attrs:{href:"https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fnecolas%2Freact-native-web",target:"_blank",rel:"noopener noreferrer"}},[t._v("React Native for Web"),a("OutboundLink")],1),t._v(" 过去常常依赖于事件系统的某些内部组件，但这种依赖关系很脆弱且经常被破坏。")]),t._v(" "),a("p",[a("strong",[t._v("在 React 17 中，这些私有导出已被移除。据我们所知，React Native for Web 是唯一使用它们的项目，它们已经完成了向不依赖那些私有导出函数的其他方法迁移。")])]),t._v(" "),a("h2",{attrs:{id:"九、启发式更新算法更新"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#九、启发式更新算法更新"}},[t._v("#")]),t._v(" 九、启发式更新算法更新")]),t._v(" "),a("p",[t._v("React 16开始替换掉了"),a("code",[t._v("Stack Reconciler")]),t._v("，开始使用启发式算法架构的的"),a("code",[t._v("Fiber Reconciler")]),t._v("。那么为什么要发生这个改变呢？")]),t._v(" "),a("p",[t._v("React的killer feature： virtual dom")]),t._v(" "),a("blockquote",[a("ul",[a("li",[t._v("React15.x - Stack Reconciler")]),t._v(" "),a("li",[t._v("React16 - Fiber Reconciler")]),t._v(" "),a("li",[t._v("React17 - Fiber Reconciler (进阶版 - 优先级区间)")])])]),t._v(" "),a("ol",[a("li",[a("p",[t._v("为什么需要fiber")]),t._v(" "),a("p",[t._v("对于大型项目，组件树会很大，这个时候递归遍历的成本就会很高，会造成主线程被持续占用，结果就是主线程上的布局、动画等周期性任务就无法立即得到处理，造成视觉上的卡顿，影响用户体验。")])]),t._v(" "),a("li",[a("p",[t._v("任务分解的意义")]),t._v(" "),a("p",[t._v("解决上面的问题")])]),t._v(" "),a("li",[a("p",[t._v("增量渲染（把渲染任务拆分成块，匀到多帧）")])]),t._v(" "),a("li",[a("p",[t._v("更新时能够暂停，终止，复用渲染任务")])]),t._v(" "),a("li",[a("p",[t._v("给不同类型的更新赋予"),a("strong",[t._v("优先级")])])]),t._v(" "),a("li",[a("p",[t._v("并发方面新的基础能力")])]),t._v(" "),a("li",[a("p",[a("strong",[t._v("更流畅")])])])]),t._v(" "),a("p",[a("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/af337110041b4b9a82d269a0668a69e7~tplv-k3u1fbpfcp-watermark.awebp",alt:"image-20190213100742491"}})]),t._v(" "),a("p",[a("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c55f16195371438682f8c5b5a5b075cd~tplv-k3u1fbpfcp-watermark.awebp",alt:"image-20190213100810277"}})]),t._v(" "),a("p",[t._v("React 17中更新了启发式更新算法，具体表现为曾经用于标记fiber节点更新优先级的expirationTime换成了为lanes，前者为普通数字，而后者则为32位的二进制，了解二进制运算的都比较熟悉了，这种二进制的lanes是可以指定几个优先级的，而不是像以前expirationTime只能标记一个。")]),t._v(" "),a("p",[t._v("之所以做这种改变，原因就是在于"),a("code",[t._v("expirationTimes模型")]),t._v("不能满足"),a("code",[t._v("IO操作")]),t._v("（Suspense），Suspense用法如下：")]),t._v(" "),a("div",{staticClass:"language-jsx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-jsx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("React.Suspense")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("fallback")]),a("span",{pre:!0,attrs:{class:"token script language-javascript"}},[a("span",{pre:!0,attrs:{class:"token script-punctuation punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Loading")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token plain-text"}},[t._v("\n   ")]),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Content")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),a("span",{pre:!0,attrs:{class:"token plain-text"}},[t._v("\n")]),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("React.Suspense")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])])])}),[],!1,null,null,null);a.default=e.exports}}]);